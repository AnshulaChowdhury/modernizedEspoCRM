#!/bin/bash

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}Starting EspoCRM...${NC}"

# Check if Docker is installed
if ! command -v docker &> /dev/null; then
    echo -e "${RED}Error: Docker is not installed. Please install Docker first.${NC}"
    exit 1
fi

# Check if Docker daemon is running
if ! docker info &> /dev/null; then
    echo -e "${RED}Error: Docker daemon is not running. Please start Docker first.${NC}"
    exit 1
fi

# Check if docker-compose or docker compose is available
if command -v docker-compose &> /dev/null; then
    COMPOSE_CMD="docker-compose"
elif docker compose version &> /dev/null; then
    COMPOSE_CMD="docker compose"
else
    echo -e "${RED}Error: Docker Compose is not installed. Please install Docker Compose first.${NC}"
    exit 1
fi

# Create .env file if it doesn't exist
if [ ! -f .env ]; then
    echo -e "${YELLOW}Creating .env file from .env.example...${NC}"
    cp .env.example .env
fi

# Load environment variables
source .env

# Set default port if not defined
ESPOCRM_PORT=${ESPOCRM_PORT:-8080}

# Stop any existing containers
echo -e "${YELLOW}Stopping any existing containers...${NC}"
$COMPOSE_CMD down 2>/dev/null || true

# Build and start containers
echo -e "${YELLOW}Building and starting containers...${NC}"
$COMPOSE_CMD up --build -d

# Wait for PostgreSQL to be ready
echo -e "${YELLOW}Waiting for PostgreSQL to be ready...${NC}"
until docker exec espocrm-db pg_isready -U "${POSTGRES_USER:-espocrm}" -d "${POSTGRES_DB:-espocrm}" &> /dev/null; do
    sleep 2
done
echo -e "${GREEN}PostgreSQL is ready.${NC}"

# Wait for the application to be ready
echo -e "${YELLOW}Waiting for EspoCRM to be ready...${NC}"
max_attempts=30
attempt=0
until curl -s -o /dev/null -w "%{http_code}" "http://localhost:${ESPOCRM_PORT}" | grep -q "200\|302\|301" || [ $attempt -eq $max_attempts ]; do
    attempt=$((attempt + 1))
    sleep 2
done

if [ $attempt -eq $max_attempts ]; then
    echo -e "${YELLOW}Application may still be starting. Check logs with: docker logs espocrm-app${NC}"
else
    echo -e "${GREEN}EspoCRM is ready!${NC}"
fi

echo ""
echo -e "${GREEN}============================================${NC}"
echo -e "${GREEN}EspoCRM is running!${NC}"
echo -e "${GREEN}============================================${NC}"
echo ""
echo -e "Application URL: ${GREEN}http://localhost:${ESPOCRM_PORT}${NC}"
echo ""
echo -e "Default credentials:"
echo -e "  Username: ${YELLOW}${ESPOCRM_ADMIN_USERNAME:-admin}${NC}"
echo -e "  Password: ${YELLOW}${ESPOCRM_ADMIN_PASSWORD:-admin}${NC}"
echo ""
echo -e "Useful commands:"
echo -e "  View logs:      ${YELLOW}docker logs -f espocrm-app${NC}"
echo -e "  Stop:           ${YELLOW}$COMPOSE_CMD down${NC}"
echo -e "  Restart:        ${YELLOW}$COMPOSE_CMD restart${NC}"
echo -e "  Database shell: ${YELLOW}docker exec -it espocrm-db psql -U ${POSTGRES_USER:-espocrm} -d ${POSTGRES_DB:-espocrm}${NC}"
echo ""
